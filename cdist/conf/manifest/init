
# The cdist_personality explorer checks /etc/cdist-personality exists
# This file describes the different personalities of the host and 
# whether cdist is enabled on that host
# Supported personalities:
# enabled
# clearcase
# kvm
# ldap
# thin


personality=""
if [ -f $__explorer/cdist_personality ] ; then
  personality=`cat "$__explorer/cdist_personality"`
fi

case "$personality" in
  *"enabled"*)

  # Record last time cdist has been run on this host
  __file /etc/cdist-lastrun
  __cdistmarker --destination /etc/cdist-lastrun

  hostname=`cat "$__explorer/hostname"`
  lsb_codename=`cat "$__explorer/lsb_codename"`
  lsb_description=`cat "$__explorer/lsb_description"`
  lsb_id=`cat "$__explorer/lsb_id"`
  lsb_release=`cat "$__explorer/lsb_release"`
  machine=`cat "$__explorer/machine"`
  os=`cat "$__explorer/os"`
  os_version=`cat "$__explorer/os_version"`

  echo "$__target_host: Personalities : ${personality}"
  echo "$__target_host: $hostname $lsb_codename $lsb_description $lsb_id $lsb_release $machine $os $os_version"

  # Things which we want to do to ALL hosts of a given OS

  common_pkgs="git iotop strace traceroute sysstat tcpdump sudo nscd ntp gcc make"

  case "$os" in
    debian|ubuntu)
      for i in $common_pkgs molly-guard pbzip2 pigz etckeeper parted iftop; do
        __package $i --state present
      done
      __package nano --state absent
      __snmpd
      __key_value Acquire::http::Proxy --file /etc/apt/apt.conf --delimiter ' ' --value "\\\"http://apt-proxy.ib.alcatel-lucent.com:3142\\\";"

    ;;
    centos|redhat)
      for i in $common_pkgs; do
        __package $i --state present
      done
      case "$lsb_release" in
        5.*)
        case "$machine" in
          i686)
            # 5.x i686 - no iftop, pbzip2, pigz, etckeeper
          ;;
          x86_64)
            # 5.x x86_64 - no iftop, pbzip2, pigz, etckeeper 
          ;;
        esac
        ;;
        6.*)
        case "$machine" in
          i686)
            # 6.x i686 - no iftop, pbzip2, pigz, etckeeper 
          ;;
          x86_64)
            # 6.x x86_64 - no iftop, pbzip2, pigz, etckeeper 
          ;;
        esac
        ;;
      esac
      __snmpd
    ;;
  esac

  case "$personality" in
    *"thin"*)
      case "$os" in
        debian|ubuntu|centos|redhat)
          echo "Personality thin"
          __zerodisk root
          __vhost_net
          __serial
        ;;
        *)
          echo "WARNING: $os not supported for thin"
        ;;
      esac
    ;;
  esac
  case "$personality" in
    *"kvm"*)
      case "$os" in
        debian|ubuntu)
          echo "Personality kvm"
          for i in qemu-kvm libvirt-bin vlan ifenslave open-iscsi iscsitarget iscsitarget-dkms glusterfs-server; do
            __package $i --state present
          done
          require="__package/libvirt-bin" __line libvirt --file /etc/libvirt/libvirtd.conf --line 'listen_tcp = 1'


        ;;
        *)
          echo "WARNING: $os not supported for kvm"
        ;;
      esac
    ;;
  esac
  case "$personality" in
    *"ldap"*)
      echo "Personality ldap"
      __ldap
      __autofs
      __sudo1
    ;;
  esac
  case "$personality" in
    *"clearcase"*)
      case "$os" in
        centos|redhat)
          echo "Personality clearcase"
          # hosts with clearcase installed...
          # additional packages
          # services
          # mountpoints (eg home dirs)
          # autofs 
        ;;
        *)
          echo "WARNING: $os not supported for clearcase"
        ;;
      esac
    ;;
  esac

  # Things we want to do for a specific host
  case "$hostname" in
    cdist.ib.alcatel-lucent.com)
    ;;
  esac 
  
  ;;
esac

